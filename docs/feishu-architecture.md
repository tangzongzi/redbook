# 飞书集成架构详解

## 整体架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              用户操作层                                   │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────────────────────┐  │
│  │  飞书 APP   │    │  Web UI     │    │  飞书群（机器人通知）        │  │
│  │  (审核)     │    │  (管理)     │    │  (生成/发布通知)            │  │
│  └──────┬──────┘    └──────┬──────┘    └─────────────────────────────┘  │
└─────────┼──────────────────┼────────────────────────────────────────────┘
          │                  │
          ▼                  ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                              服务层                                       │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐     │
│  │   xhs-web       │    │   xhs-generator │    │   xhs-mcp       │     │
│  │   (Flask API)   │    │   (定时生成)     │    │   (小红书 MCP)  │     │
│  │                 │    │                 │    │                 │     │
│  │  • 飞书写入     │    │  • AI 生成内容  │    │  • 扫码登录     │     │
│  │  • 飞书轮询     │    │  • 搜索关键词   │    │  • 发布笔记     │     │
│  │  • Webhook    │    │  • 生成图片     │    │                 │     │
│  └────────┬────────┘    └─────────────────┘    └────────┬────────┘     │
└───────────┼──────────────────────────────────────────────┼──────────────┘
            │                                              │
            ▼                                              ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                           外部服务层                                      │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐     │
│  │  飞书开放平台   │    │   DeepSeek API  │    │   小红书 APP    │     │
│  │                 │    │                 │    │                 │     │
│  │  • 多维表格     │    │  • 内容生成     │    │  • 笔记发布     │     │
│  │  • 机器人       │    │                 │    │                 │     │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘     │
└─────────────────────────────────────────────────────────────────────────┘
```

## 数据流详解

### 1. 内容生成流程

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│ 定时触发/   │────▶│  xhs-web    │────▶│ DeepSeek    │────▶│ 生成内容    │
│ 手动触发    │     │  /generate  │     │   API       │     │             │
└─────────────┘     └──────┬──────┘     └─────────────┘     └──────┬──────┘
                           │                                        │
                           │  同时                                  │
                           ▼                                        ▼
                    ┌─────────────┐                          ┌─────────────┐
                    │ 飞书多维表格 │                          │ 本地队列    │
                    │ (状态:待审) │                          │ (状态:pending)│
                    └─────────────┘                          └─────────────┘
                           │
                           ▼
                    ┌─────────────┐
                    │ 飞书群通知  │
                    │ "新内容待审" │
                    └─────────────┘
```

### 2. 飞书审核流程

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│ 用户打开    │────▶│ 修改状态    │────▶│ xhs-web     │────▶│ 检测状态    │
│ 飞书表格    │     │ 待审→已通过  │     │ 轮询检测    │     │ 变更        │
└─────────────┘     └─────────────┘     └──────┬──────┘     └──────┬──────┘
                                               │                    │
                                               │ 每5分钟检查一次     │
                                               ▼                    │
                                        ┌─────────────┐            │
                                        │ 调用 MCP    │◀───────────┘
                                        │ 发布笔记    │
                                        └──────┬──────┘
                                               │
                                               ▼
                                        ┌─────────────┐
                                        │ 更新飞书    │
                                        │ 状态:已发布  │
                                        └──────┬──────┘
                                               │
                                               ▼
                                        ┌─────────────┐
                                        │ 发送成功    │
                                        │ 通知到群    │
                                        └─────────────┘
```

### 3. API 手动同步流程

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│ 用户调用    │────▶│ xhs-web     │────▶│ 查询飞书    │────▶│ 获取已通过  │
│ /feishu/sync│     │ 同步接口    │     │ 表格        │     │ 的记录列表  │
└─────────────┘     └──────┬──────┘     └─────────────┘     └──────┬──────┘
                           │                                        │
                           │                                        ▼
                           │                               ┌─────────────┐
                           │                               │ 逐条发布到  │
                           │                               │ 小红书      │
                           │                               └──────┬──────┘
                           │                                      │
                           ▼                                      ▼
                    ┌─────────────┐                       ┌─────────────┐
                    │ 返回结果    │                       │ 更新飞书    │
                    │ {           │                       │ 状态        │
                    │   published:3│                       │             │
                    │ }           │                       │             │
                    └─────────────┘                       └─────────────┘
```

## 飞书表格字段说明

| 字段名 | 类型 | 说明 | 示例值 |
|--------|------|------|--------|
| 标题 | 文本 | 小红书笔记标题 | 🚀 2024年最值得学的AI工具 |
| 正文 | 多行文本 | 笔记正文内容 | 姐妹们！今天给大家安利... |
| 标签 | 文本 | 话题标签，逗号分隔 | #AI工具, #效率提升 |
| 摘要 | 文本 | 一句话摘要 | 推荐5个提升效率的AI工具 |
| 关键词 | 文本 | 搜索关键词 | AI人工智能 |
| 图片路径 | 文本 | 图片URL或路径 | /app/data/images/xxx.jpg |
| 状态 | 单选 | 内容状态 | 待审核/已通过/已拒绝/已发布/发布失败 |
| 创建时间 | 日期时间 | 自动生成时间 | 2024-01-15 09:00:00 |
| 发布时间 | 日期时间 | 实际发布时间 | 2024-01-15 10:30:00 |
| 笔记ID | 文本 | 发布后的小红书ID | 656xxxxx |
| 分享链接 | 文本 | 笔记分享链接 | https://www.xiaohongshu.com/... |

## 状态流转图

```
                    ┌──────────┐
         ┌─────────│  已拒绝   │
         │         └──────────┘
         │
┌────────▼────────┐    用户审核通过      ┌──────────┐
│                 │──────────────────────▶│          │
│    待审核       │                       │  已通过   │
│   (初始状态)    │◀──────────────────────│          │
│                 │    审核不通过/拒绝     └────┬─────┘
└─────────────────┘                             │
                                                │ 系统自动发布
                                                ▼
                                         ┌──────────┐
                                发布成功  │          │
                               ◀──────────│  已发布   │
                               │          │          │
                               │          └──────────┘
                               │
                               │ 发布失败
                               ▼
                          ┌──────────┐
                          │ 发布失败  │
                          └──────────┘
```

## 配置优先级

当同时启用了 Web UI 和飞书集成时：

1. **内容生成** → 同时写入本地和飞书
2. **内容审核** → 可以在 Web UI 或飞书中任选一个
3. **内容发布** → 
   - Web UI 点击发布 → 发布 + 更新飞书状态
   - 飞书修改状态 → 自动检测并发布

## 故障排查

### 飞书写入失败

检查日志：
```bash
docker logs xhs-web | grep FEISHU
```

常见问题：
1. App ID / Secret 错误
2. 应用未发布
3. 权限未申请（bitable:record, bitable:app）
4. 表格不存在或字段名称不匹配

### 飞书轮询不工作

检查：
1. `feishu.enabled` 是否为 `true`
2. 轮询线程是否启动（查看启动日志）
3. 表格中是否有「已通过」状态的记录

### Webhook 通知失败

检查：
1. Webhook URL 是否正确
2. 飞书群机器人是否被删除
3. 网络是否能访问飞书服务器

## 安全建议

1. **权限最小化**：飞书应用只申请必要的权限
2. **Secret 保护**：不要提交 `.env` 文件到 Git
3. **IP 白名单**：如可能，在飞书开放平台配置 IP 白名单
4. **定期轮换**：定期更换 App Secret
